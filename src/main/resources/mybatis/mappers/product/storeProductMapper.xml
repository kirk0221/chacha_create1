<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chacha.create.common.mapper.product.StoreProductMapper">

	<resultMap id="bestProductResultMap" type="storeProductDTO">
		<id property="productId" column="product_id" />
		<result property="storeId" column="store_id" />
		<result property="typeCategoryId" column="type_category_id" />
		<result property="dCategoryId" column="d_category_id" />
		<result property="productName" column="product_name" />
		<result property="price" column="price" />
		<result property="productDetail" column="product_detail" />
		<result property="stock" column="stock" />
		<result property="productDate" column="product_date" />
		<result property="lastModifiedDate" column="last_modified_date" />
		<result property="saleCnt" column="sale_cnt" />
		<result property="viewCnt" column="view_cnt" />
		
		<result property="typeCategoryName" column="type_category_name"/>
		<result property="dCategoryName" column="d_category_name"/>
		<result property="uCategoryName" column="u_category_name"/>
		<result property="pImgUrl" column="p_img_url"/>
	</resultMap>
	
	<!-- 사용자가 상품이름으로 검색했을때  -->

	<select id="selectByProductName" resultType="com.chacha.create.common.dto.product.StoreProductDTO" parameterType="map">
	SELECT p.*, ca.type_category_name, dc.d_category_name, uc.u_category_name, img.p_img_url
	FROM product p
	LEFT JOIN type_category ca ON p.type_category_id = ca.type_category_id
	LEFT JOIN d_category dc ON p.d_category_id = dc.d_category_id
	LEFT JOIN u_category uc ON dc.u_category_id = uc.u_category_id
	LEFT JOIN (
	    SELECT product_id, p_img_url
	    FROM (
	        SELECT product_id, p_img_url,
	               ROW_NUMBER() OVER (PARTITION BY product_id ORDER BY p_img_seq ASC) AS rn
	        FROM p_img
	    ) sub
	    WHERE rn = 1    
	) img ON p.product_id = img.product_id
	WHERE p.store_id = #{storeId}
	AND p.delete_check = 0
	AND p.product_name LIKE '%' || #{keyword} || '%'
	</select>
	
	<!-- 특정 스토어의 전체 상품 조회 -->
    <select id="selectForProductList" resultType="com.chacha.create.common.dto.product.StoreProductDTO" parameterType="map">
        SELECT p.*, ca.type_category_name, dc.d_category_name, uc.u_category_name, img.p_img_url
        FROM product p
        LEFT JOIN type_category ca ON p.type_category_id = ca.type_category_id
        LEFT JOIN d_category dc ON p.d_category_id = dc.d_category_id
        LEFT JOIN u_category uc ON dc.u_category_id = uc.u_category_id
        LEFT JOIN (
            SELECT product_id, p_img_url
            FROM (
                SELECT product_id, p_img_url,
                       ROW_NUMBER() OVER (PARTITION BY product_id ORDER BY p_img_seq ASC) AS rn
                FROM p_img
            ) sub
            WHERE rn = 1
        ) img ON p.product_id = img.product_id
       WHERE p.store_id = #{storeId}
	  AND p.delete_check = 0
	  
	  <!-- 카테고리 필터 -->
	  <if test="categoryMap != null 
      and ((categoryMap.type != null and categoryMap.type.size() > 0) 
        or (categoryMap.d != null and categoryMap.d.size() > 0) 
        or (categoryMap.u != null and categoryMap.u.size() > 0))">
			AND (
			<if test="categoryMap.type != null">
				p.type_category_id IN
				<foreach collection="categoryMap.type" item="id" open="("
					separator="," close=")">
					#{id}
				</foreach>
			</if>
			<if test="categoryMap.d != null">
				<if test="categoryMap.type != null">OR</if>
				p.d_category_id IN
				<foreach collection="categoryMap.d" item="id" open="("
					separator="," close=")">
					#{id}
				</foreach>
			</if>
			<if test="categoryMap.u != null">
				<if test="categoryMap.type != null or categoryMap.d != null">OR</if>
				uc.u_category_id IS NOT NULL
				AND uc.u_category_id IN
				<foreach collection="categoryMap.u" item="id" open="("
					separator="," close=")">
					#{id}
				</foreach>
			</if>
			)
		</if>

          <!-- 정렬 조건 -->
          <choose>
          <when test="sort == 'latest'">				<!-- 최신 -->		
            ORDER BY p.product_date DESC
          </when>
          <when test="sort == 'popular'">			<!-- 인기순 -->
            ORDER BY p.sale_cnt DESC
          </when>
          <when test="sort == 'korasc'">			<!-- 가나다순 -->
            ORDER BY p.product_name ASC
          </when>
          <otherwise>
            ORDER BY p.product_date DESC
          </otherwise>
        </choose>
    </select>
	
	
	
	<!-- 스토어ID로 해당 스토어의 대표상품 조회 -->
	<select id="selectForStoreMainProduct" resultMap="bestProductResultMap">
		<![CDATA[
			select *
			FROM product
			WHERE FLAGSHIP_CHECK = 1
			AND STORE_ID = #{store_id}
		]]>
	</select>
	
	<!-- 해당 스토어의 인기 상품 조회  -->
	<select id="selectForBestProduct" resultMap="bestProductResultMap">
		<![CDATA[
			SELECT p.*, ca.type_category_name, dc.d_category_name, uc.u_category_name, img.p_img_url
			FROM product p
			JOIN (
			    SELECT product_id
			    FROM (
			        SELECT product_id
			        FROM product
			        WHERE store_id = #{storeId}
			        ORDER BY sale_cnt DESC
			    )
			    WHERE ROWNUM <= 3
			) best ON p.product_id = best.product_id
			LEFT JOIN type_category ca ON p.type_category_id = ca.type_category_id
			LEFT JOIN d_category dc ON p.d_category_id = dc.d_category_id
			LEFT JOIN u_category uc ON dc.u_category_id = uc.u_category_id
			LEFT JOIN (
			    SELECT product_id, p_img_url
			    FROM (
			        SELECT product_id, p_img_url,
			               ROW_NUMBER() OVER (PARTITION BY product_id ORDER BY p_img_seq ASC) AS rn
			        FROM p_img
			    ) sub
			    WHERE rn = 1    
			) img ON p.product_id = img.product_id
			WHERE p.delete_check = 0
		]]>
	</select>
	
	</mapper>
	